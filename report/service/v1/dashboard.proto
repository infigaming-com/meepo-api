syntax = "proto3";

package api.report.service.v1;

import "google/api/annotations.proto";
import "google/protobuf/timestamp.proto";
import "common/common.proto";
import "backoffice/service/v1/backoffice_dashboard.proto";

option go_package = "github.com/infigaming-com/meepo-api/report/service/v1;v1";
option java_multiple_files = true;
option java_package = "api.report.service.v1";

// Internal Request messages for gRPC communication between services
// These messages include operator_context field which MUST NOT be exposed to frontend

message GetOverviewDashboardRequest {
	api.common.OperatorContextFilters operator_context_filters = 1;
	api.common.OperatorContext operator_context = 2;  // Internal only - injected by backoffice-service
}

message GetTimeRangedDashboardRequest {
	api.backoffice.service.v1.GetTimeRangedDashboardRequest.TimeRangeType time_range_type = 1;
	int32 custom_days = 2;
	api.common.OperatorContextFilters operator_context_filters = 3;
	api.common.OperatorContext operator_context = 4;  // Internal only
}

message GetTopUsersDashboardRequest {
	api.backoffice.service.v1.GetTopUsersDashboardRequest.TimeRangeType time_range_type = 1;
	api.common.OperatorContextFilters operator_context_filters = 2;
	api.common.OperatorContext operator_context = 3;  // Internal only
}

message GetTopOperatorsDashboardRequest {
	api.backoffice.service.v1.GetTopOperatorsDashboardRequest.TimeRangeType time_range_type = 1;
	api.common.OperatorContextFilters operator_context_filters = 2;
	api.common.OperatorContext operator_context = 3;  // Internal only
}

// DashboardService provides dashboard analytics via ClickHouse.
// This service is the ONLY service allowed to query ClickHouse directly for dashboard data.
service DashboardService {
  // Overview dashboard with today/yesterday comparison
  rpc GetOverviewDashboard(GetOverviewDashboardRequest) returns (api.backoffice.service.v1.GetOverviewDashboardResponse) {
    option (google.api.http) = {
      post: "/v1/report/dashboard/overview/get"
      body: "*"
    };
  }

  // Time-ranged dashboard (this month/week/custom days)
  rpc GetTimeRangedDashboard(GetTimeRangedDashboardRequest) returns (api.backoffice.service.v1.GetTimeRangedDashboardResponse) {
    option (google.api.http) = {
      post: "/v1/report/dashboard/time-ranged/get"
      body: "*"
    };
  }

  // Top users dashboard (deposits/withdrawals)
  rpc GetTopUsersDashboard(GetTopUsersDashboardRequest) returns (api.backoffice.service.v1.GetTopUsersDashboardResponse) {
    option (google.api.http) = {
      post: "/v1/report/dashboard/top-users/get"
      body: "*"
    };
  }

  // Top operators dashboard (GGR/NGR/deposits-withdrawals)
  rpc GetTopOperatorsDashboard(GetTopOperatorsDashboardRequest) returns (api.backoffice.service.v1.GetTopOperatorsDashboardResponse) {
    option (google.api.http) = {
      post: "/v1/report/dashboard/top-operators/get"
      body: "*"
    };
  }

  // ============================================================================
  // Affiliate Dashboard RPCs
  // All metrics are filtered by user registration date (not event date)
  // ============================================================================

  // Affiliate dashboard with aggregated metrics, balance, and product stats
  rpc GetAffiliateDashboard(GetAffiliateDashboardRequest) returns (GetAffiliateDashboardResponse) {}

  // Affiliate trend data (time series)
  rpc GetAffiliateTrend(GetAffiliateTrendRequest) returns (GetAffiliateTrendResponse) {}
}

// ============================================================================
// Affiliate Dashboard Messages
// ============================================================================

message GetAffiliateDashboardRequest {
  int64 affiliate_id = 1;
  google.protobuf.Timestamp start_time = 2;
  google.protobuf.Timestamp end_time = 3;
  optional int32 game_stats_limit = 4;  // limit for game stats, group by provider,default 10
  api.common.OperatorContext initiator_operator_context = 5;
}

message GetAffiliateDashboardResponse {
  // Nested types
  message CurrencyBalance {
    string currency = 1;
    int64 accounts_count = 2;
    string total_balance = 3;
  }

  message ProductStats {
    string game_id = 1;
    string game_name = 2;
    string provider_id = 3;    // Provider ID for grouping
    string provider_name = 4;
    string category = 5;
    int64 active_users = 6;
    string ggr_usd = 7;
    string ngr_usd = 8;
    int64 bet_count = 9;
    string bet_amount_usd = 10;
  }

  // User Conversion metrics
  int64 registrations = 1;
  int64 ftd_users = 2;
  int64 repeat_depositors = 3;
  int64 active_users = 4;

  // Financial metrics
  string deposits_usd = 5;
  string withdrawals_usd = 6;
  string pending_withdrawals_usd = 7;

  // Gaming metrics
  string ggr_usd = 8;
  string ngr_usd = 9;
  int64 bet_count = 10;
  string bet_amount_usd = 11;

  // Calculated metrics
  string average_bet_usd = 12;
  string reg_to_ftd_rate = 13;
  string ftd_to_active_rate = 14;

  // Balance by currency
  repeated CurrencyBalance balances = 15;
  int64 total_accounts_with_balance = 16;

  // Product stats
  map<string, ProductStats> products = 17; // key is provider id
}

message GetAffiliateTrendRequest {
  int64 affiliate_id = 1;
  google.protobuf.Timestamp start_time = 2;
  google.protobuf.Timestamp end_time = 3;
  string group_by = 4;  // "day", "week", "month"
  api.common.OperatorContext initiator_operator_context = 5;
}

message GetAffiliateTrendResponse {
  message TrendData {
    google.protobuf.Timestamp date = 1;
    int64 registrations = 2;
    int64 ftd_users = 3;
    int64 repeat_depositors = 4;
    int64 active_users = 5;
    string deposits_usd = 6;
    string withdrawals_usd = 7;
    string ggr_usd = 8;
    string ngr_usd = 9;
    int64 bet_count = 10;
    string bet_amount_usd = 11;
  }
  repeated TrendData data = 1;
}
