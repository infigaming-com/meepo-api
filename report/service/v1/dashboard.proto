syntax = "proto3";

package api.report.service.v1;

import "google/api/annotations.proto";
import "google/protobuf/timestamp.proto";
import "backoffice/service/v1/backoffice_dashboard.proto";
import "common/common.proto";

option go_package = "github.com/infigaming-com/meepo-api/report/service/v1;v1";
option java_multiple_files = true;
option java_package = "api.report.service.v1";

// DashboardService provides dashboard analytics via ClickHouse.
// This service is the ONLY service allowed to query ClickHouse directly for dashboard data.
service DashboardService {
  // Overview dashboard with today/yesterday comparison
  rpc GetOverviewDashboard(api.backoffice.service.v1.GetOverviewDashboardRequest) returns (api.backoffice.service.v1.GetOverviewDashboardResponse) {
    option (google.api.http) = {
      post: "/v1/report/dashboard/overview/get"
      body: "*"
    };
  }

  // Time-ranged dashboard (this month/week/custom days)
  rpc GetTimeRangedDashboard(api.backoffice.service.v1.GetTimeRangedDashboardRequest) returns (api.backoffice.service.v1.GetTimeRangedDashboardResponse) {
    option (google.api.http) = {
      post: "/v1/report/dashboard/time-ranged/get"
      body: "*"
    };
  }

  // Top users dashboard (deposits/withdrawals)
  rpc GetTopUsersDashboard(api.backoffice.service.v1.GetTopUsersDashboardRequest) returns (api.backoffice.service.v1.GetTopUsersDashboardResponse) {
    option (google.api.http) = {
      post: "/v1/report/dashboard/top-users/get"
      body: "*"
    };
  }

  // Top operators dashboard (GGR/NGR/deposits-withdrawals)
  rpc GetTopOperatorsDashboard(api.backoffice.service.v1.GetTopOperatorsDashboardRequest) returns (api.backoffice.service.v1.GetTopOperatorsDashboardResponse) {
    option (google.api.http) = {
      post: "/v1/report/dashboard/top-operators/get"
      body: "*"
    };
  }

  // ============================================================================
  // Affiliate Dashboard RPCs
  // All metrics are filtered by user registration date (not event date)
  // ============================================================================

  // Affiliate dashboard with aggregated metrics, balance, and product stats
  rpc GetAffiliateDashboard(GetAffiliateDashboardRequest) returns (GetAffiliateDashboardResponse) {
    option (google.api.http) = {
      post: "/v1/report/dashboard/affiliate/get"
      body: "*"
    };
  }

  // Affiliate trend data (time series)
  rpc GetAffiliateTrend(GetAffiliateTrendRequest) returns (GetAffiliateTrendResponse) {
    option (google.api.http) = {
      post: "/v1/report/dashboard/affiliate/trend/get"
      body: "*"
    };
  }
}

// ============================================================================
// Affiliate Dashboard Messages
// ============================================================================

message GetAffiliateDashboardRequest {
  int64 affiliate_id = 1;
  google.protobuf.Timestamp start_time = 2;
  google.protobuf.Timestamp end_time = 3;
  optional int32 product_stats_limit = 4;  // limit for product stats, default 50
  api.common.OperatorContext initiator_operator_context = 5;
}

message GetAffiliateDashboardResponse {
  // Nested types
  message CurrencyBalance {
    string currency = 1;
    int64 accounts_count = 2;
    string total_balance = 3;
  }

  message ProductStats {
    string game_id = 1;
    string game_name = 2;
    string provider_name = 3;
    string category = 4;
    int64 active_users = 5;
    string ggr_usd = 6;
    string ngr_usd = 7;
    int64 bet_count = 8;
    string bet_amount_usd = 9;
  }

  // User Conversion metrics
  int64 registrations = 1;
  int64 ftd_users = 2;
  int64 repeat_depositors = 3;
  int64 active_users = 4;

  // Financial metrics
  string deposits_usd = 5;
  string withdrawals_usd = 6;
  string pending_withdrawals_usd = 7;

  // Gaming metrics
  string ggr_usd = 8;
  string ngr_usd = 9;
  int64 bet_count = 10;
  string bet_amount_usd = 11;

  // Calculated metrics
  string average_bet_usd = 12;
  string reg_to_ftd_rate = 13;
  string ftd_to_active_rate = 14;

  // Balance by currency
  repeated CurrencyBalance balances = 15;
  int64 total_accounts_with_balance = 16;

  // Product stats
  repeated ProductStats products = 17;
}

message GetAffiliateTrendRequest {
  int64 affiliate_id = 1;
  google.protobuf.Timestamp start_time = 2;
  google.protobuf.Timestamp end_time = 3;
  string group_by = 4;  // "day", "week", "month"
  api.common.OperatorContext initiator_operator_context = 5;
}

message GetAffiliateTrendResponse {
  message TrendData {
    google.protobuf.Timestamp date = 1;
    int64 registrations = 2;
    int64 ftd_users = 3;
    int64 repeat_depositors = 4;
    int64 active_users = 5;
    string deposits_usd = 6;
    string withdrawals_usd = 7;
    string ggr_usd = 8;
    string ngr_usd = 9;
    int64 bet_count = 10;
    string bet_amount_usd = 11;
  }
  repeated TrendData data = 1;
}
