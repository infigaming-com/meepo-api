name: Deploy API Documentation to GCS

on:
  push:
    branches: [ main ]
    paths:
      - 'openapi.yaml'
      - 'openapi.yml'
      - 'docs/**'
  pull_request:
    branches: [ main ]
    paths:
      - 'openapi.yaml'
      - 'openapi.yml'
      - 'docs/**'
  workflow_dispatch:
    inputs:
      openapi_file:
        description: 'OpenAPI specification file path'
        required: false
        default: 'openapi.yaml'

env:
  BUCKET_NAME: 'speedix-meepo-api-docs'
  OPENAPI_FILE: ${{ github.event.inputs.openapi_file || 'openapi.yaml' }}

jobs:
  deploy-docs:
    runs-on: self-hosted
    
    permissions:
      contents: read
      id-token: write  # ç”¨äºWorkload Identity Federation
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
    
    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '20'
        cache: 'npm'
    
    - name: Generate Redoc documentation
      run: |
        echo "ç”ŸæˆRedocæ–‡æ¡£..."
        npx @redocly/cli build-docs "$OPENAPI_FILE" --output index.html
        
        # éªŒè¯ç”Ÿæˆçš„æ–‡ä»¶
        if [ ! -f "index.html" ]; then
          echo "é”™è¯¯: æœªèƒ½ç”Ÿæˆindex.htmlæ–‡ä»¶"
          exit 1
        fi
        
        echo "æˆåŠŸç”Ÿæˆæ–‡æ¡£: index.html"
        echo "æ–‡ä»¶å¤§å°: $(du -h index.html)"
    
    - name: Authenticate to Google Cloud
      uses: google-github-actions/auth@v2
      with:
        credentials_json: "${{ secrets.GCR_SA_KEY }}"

    - name: Setup Google Cloud SDK
      uses: google-github-actions/setup-gcloud@v2
      with:
        version: 'latest'
    
    - name: Ensure GCS bucket exists
      run: |
        echo "ç¡®ä¿å­˜å‚¨æ¡¶å­˜åœ¨: gs://$BUCKET_NAME"
        if ! gsutil ls -b "gs://$BUCKET_NAME" &>/dev/null; then
          echo "åˆ›å»ºå­˜å‚¨æ¡¶: gs://$BUCKET_NAME"
          gsutil mb "gs://$BUCKET_NAME"
          
          # è®¾ç½®å­˜å‚¨æ¡¶ä¸ºå…¬å…±å¯è¯»
          gsutil iam ch allUsers:objectViewer "gs://$BUCKET_NAME"
        else
          echo "å­˜å‚¨æ¡¶å·²å­˜åœ¨: gs://$BUCKET_NAME"
        fi
    
    - name: Deploy to Google Cloud Storage
      run: |
        echo "ä¸Šä¼ æ–‡æ¡£åˆ°GCS..."
        
        # ä¸Šä¼ ä¸»æ–‡æ¡£æ–‡ä»¶
        gsutil -h "Cache-Control:public,max-age=3600" \
               -h "Content-Type:text/html" \
               cp index.html "gs://$BUCKET_NAME/index.html"
        
        # å¦‚æœæœ‰å…¶ä»–é™æ€èµ„æºï¼Œä¹Ÿå¯ä»¥ä¸Šä¼ 
        if [ -d "assets" ]; then
          echo "ä¸Šä¼ èµ„æºæ–‡ä»¶..."
          gsutil -h "Cache-Control:public,max-age=86400" \
                 cp -r assets "gs://$BUCKET_NAME/"
        fi
        
        echo "è®¾ç½®å…¬å…±è®¿é—®æƒé™..."
        gsutil acl ch -u AllUsers:R "gs://$BUCKET_NAME/index.html"
    
    - name: Output deployment info
      run: |
        echo "## ğŸš€ éƒ¨ç½²å®Œæˆ!" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "- **å­˜å‚¨æ¡¶**: gs://$BUCKET_NAME" >> $GITHUB_STEP_SUMMARY
        echo "- **è®¿é—®é“¾æ¥**: https://storage.googleapis.com/$BUCKET_NAME/index.html" >> $GITHUB_STEP_SUMMARY
        echo "- **OpenAPIæ–‡ä»¶**: $OPENAPI_FILE" >> $GITHUB_STEP_SUMMARY
        echo "- **éƒ¨ç½²æ—¶é—´**: $(date -u '+%Y-%m-%d %H:%M:%S UTC')" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "---" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "éƒ¨ç½²å®Œæˆ!"
        echo "è®¿é—®é“¾æ¥: https://storage.googleapis.com/$BUCKET_NAME/index.html"
    
    # å¯é€‰: é€šçŸ¥éƒ¨ç½²ç»“æœ
    - name: Notify deployment status
      if: always()
      run: |
        if [ "${{ job.status }}" == "success" ]; then
          echo "âœ… APIæ–‡æ¡£éƒ¨ç½²æˆåŠŸ"
          echo "ğŸ“– è®¿é—®åœ°å€: https://storage.googleapis.com/$BUCKET_NAME/index.html"
        else
          echo "âŒ APIæ–‡æ¡£éƒ¨ç½²å¤±è´¥"
        fi
