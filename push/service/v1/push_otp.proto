syntax = "proto3";

package api.push.service.v1;

import "common/common.proto";

option go_package = "github.com/infigaming-com/meepo-api/push/service/v1;v1";
option java_multiple_files = true;
option java_package = "api.push.service.v1";

// PushOTP service for OTP delivery, provider/template management, and send logs
service PushOTP {
  // ====== Inter-service: OTP delivery ======
  rpc SendOTP(SendOTPRequest) returns (SendOTPResponse) {}

  // ====== Backoffice: Provider CRUD ======
  rpc CreateOTPProvider(CreateOTPProviderRequest) returns (CreateOTPProviderResponse) {}
  rpc UpdateOTPProvider(UpdateOTPProviderRequest) returns (UpdateOTPProviderResponse) {}
  rpc DeleteOTPProvider(DeleteOTPProviderRequest) returns (DeleteOTPProviderResponse) {}
  rpc GetOTPProvider(GetOTPProviderRequest) returns (GetOTPProviderResponse) {}
  rpc ListOTPProviders(ListOTPProvidersRequest) returns (ListOTPProvidersResponse) {}

  // ====== Backoffice: Template CRUD ======
  rpc CreateOTPTemplate(CreateOTPTemplateRequest) returns (CreateOTPTemplateResponse) {}
  rpc UpdateOTPTemplate(UpdateOTPTemplateRequest) returns (UpdateOTPTemplateResponse) {}
  rpc DeleteOTPTemplate(DeleteOTPTemplateRequest) returns (DeleteOTPTemplateResponse) {}
  rpc GetOTPTemplate(GetOTPTemplateRequest) returns (GetOTPTemplateResponse) {}
  rpc ListOTPTemplates(ListOTPTemplatesRequest) returns (ListOTPTemplatesResponse) {}
  rpc SyncOTPTemplateStatus(SyncOTPTemplateStatusRequest) returns (SyncOTPTemplateStatusResponse) {}

  // ====== Backoffice: Send logs ======
  rpc ListOTPSendLogs(ListOTPSendLogsRequest) returns (ListOTPSendLogsResponse) {}
}

// ============ Enums ============

enum OTPChannel {
  OTP_CHANNEL_UNSPECIFIED = 0;
  OTP_CHANNEL_SMS = 1;
  OTP_CHANNEL_WHATSAPP = 2;
  OTP_CHANNEL_VOICE = 3;
  OTP_CHANNEL_EMAIL = 4;
}

// OTPProviderType enumerates the supported third-party OTP delivery providers.
// New providers should be added here as the platform integrates them.
enum OTPProviderType {
  OTP_PROVIDER_TYPE_UNSPECIFIED = 0;
  OTP_PROVIDER_TYPE_ENGAGELAB = 1;   // EngageLab (SMS, WhatsApp, Voice)
}

// OTPSendChannelStrategy defines the channel delivery order for an OTP provider.
// The system tries channels left-to-right; if the first channel fails, it falls back to the next.
enum OTPSendChannelStrategy {
  OTP_SEND_CHANNEL_STRATEGY_UNSPECIFIED = 0;
  OTP_SEND_CHANNEL_STRATEGY_SMS = 1;                   // SMS only
  OTP_SEND_CHANNEL_STRATEGY_WHATSAPP_SMS = 2;           // WhatsApp first, fallback to SMS
  OTP_SEND_CHANNEL_STRATEGY_WHATSAPP_SMS_VOICE = 3;     // WhatsApp → SMS → Voice
}

enum OTPTemplateType {
  OTP_TEMPLATE_TYPE_UNSPECIFIED = 0;
  OTP_TEMPLATE_TYPE_EMAIL_VERIFICATION = 1;
  OTP_TEMPLATE_TYPE_LOGIN_OTP = 2;
  OTP_TEMPLATE_TYPE_PASSWORD_RESET = 3;
  OTP_TEMPLATE_TYPE_WITHDRAWAL_CONFIRM = 4;
}

// OTPTemplateReviewStatus represents the approval state of a template on the external provider.
//
// Some providers (e.g., EngageLab WhatsApp) require templates to be reviewed before use.
// SMS templates typically do not require review and will return LOCAL_ONLY.
//
// Lifecycle:
//   1. Template created locally → LOCAL_ONLY (can be used for SMS immediately)
//   2. Template submitted to provider for review → PENDING
//   3. Provider approves → APPROVED (can be used for WhatsApp)
//   4. Provider rejects → REJECTED (cannot be used; fix and resubmit on provider platform)
//
// Use SyncOTPTemplateStatus to pull the latest status from the provider.
enum OTPTemplateReviewStatus {
  OTP_TEMPLATE_REVIEW_STATUS_UNSPECIFIED = 0;  // Default zero value, should not appear in practice
  OTP_TEMPLATE_REVIEW_STATUS_LOCAL_ONLY = 1;   // Template exists only locally, no external review needed (e.g., SMS)
  OTP_TEMPLATE_REVIEW_STATUS_PENDING = 2;      // Submitted to provider, awaiting review (e.g., WhatsApp template)
  OTP_TEMPLATE_REVIEW_STATUS_APPROVED = 3;     // Approved by provider, ready for use
  OTP_TEMPLATE_REVIEW_STATUS_REJECTED = 4;     // Rejected by provider, cannot be used until fixed and resubmitted
}

// ============ SendOTP (inter-service) ============

message SendOTPRequest {
  string recipient = 1;                       // E.164 phone number or email
  string code = 2;                            // OTP code generated by caller
  OTPTemplateType template_type = 3;          // Business scenario
  int64 operator_id = 4;
  int64 company_operator_id = 5;
  int64 retailer_operator_id = 6;
  int64 user_id = 7;
  string country = 8;                         // ISO 3166-1 alpha-2
  string language = 9;                        // Template language (e.g., "en", "pt")
  string ip_address = 10;                     // For rate limiting
  map<string, string> extra_params = 11;      // Extra template parameters
  optional OTPChannel preferred_channel = 12; // Preferred delivery channel
}

message SendOTPResponse {
  string message_id = 1;
  string external_message_id = 2;
  string channel_used = 3;
  string provider_name = 4;
}

// ============ Provider CRUD ============

// OTPProviderInfo represents an OTP provider configuration.
// Credentials are NEVER exposed in responses; only has_credentials indicates whether they are set.
message OTPProviderInfo {
  int64 id = 1;
  int64 operator_id = 2;
  string country = 3;
  OTPProviderType provider_type = 4;
  string name = 5;
  bool enabled = 6;
  int32 priority = 7;
  bool has_credentials = 8;   // Never expose credentials in response
  string config = 9;          // JSON string of non-sensitive config
  OTPSendChannelStrategy send_channel_strategy = 10;
  int64 created_at = 11;
  int64 updated_at = 12;
}

// CreateOTPProviderRequest registers an OTP delivery provider for a specific operator + country.
//
// An OTP provider represents a third-party service (e.g., EngageLab) capable of delivering
// OTP codes via SMS, WhatsApp, or Voice channels. Each operator can have multiple providers
// for different countries, with priority-based fallback routing.
//
// Routing chain when SendOTP is called:
//   1. (operator_id, country, enabled=true) ORDER BY priority ASC
//   2. (operator_id, "global", enabled=true) ORDER BY priority ASC
//   3. (system_operator_id, country, enabled=true) ORDER BY priority ASC
//   4. (system_operator_id, "global", enabled=true) ORDER BY priority ASC
//
// Constraint: UNIQUE(operator_id, country, provider_type).
message CreateOTPProviderRequest {
  int64 operator_id = 1;                        // Operator this provider belongs to
  string country = 2;                           // ISO 3166-1 alpha-2 (e.g., "BR"), or "global" for default fallback
  OTPProviderType provider_type = 3;            // Third-party provider to use (e.g., OTP_PROVIDER_TYPE_ENGAGELAB)
  string name = 4;                              // Human-readable display name
  bool enabled = 5;                             // Whether this provider is active for routing
  int32 priority = 6;                           // Routing priority within same (operator_id, country). Lower = higher priority
  string credentials_json = 7;                  // Plain JSON with provider-specific credentials. Encrypted (AES-256-GCM) before storage.
                                                // EngageLab example: {"dev_key":"xxx","dev_secret":"yyy"}
  string config = 8;                            // JSON string of non-sensitive config (base_url, timeouts). Optional.
  OTPSendChannelStrategy send_channel_strategy = 9; // Channel delivery order (e.g., OTP_SEND_CHANNEL_STRATEGY_WHATSAPP_SMS)
}

message CreateOTPProviderResponse {
  OTPProviderInfo provider = 1;
}

message UpdateOTPProviderRequest {
  int64 id = 1;
  optional string name = 2;
  optional bool enabled = 3;
  optional int32 priority = 4;
  optional string credentials_json = 5;
  optional string config = 6;
  optional OTPSendChannelStrategy send_channel_strategy = 7;
}

message UpdateOTPProviderResponse {}

message DeleteOTPProviderRequest {
  int64 id = 1;
}

message DeleteOTPProviderResponse {}

message GetOTPProviderRequest {
  int64 id = 1;
}

message GetOTPProviderResponse {
  OTPProviderInfo provider = 1;
}

message ListOTPProvidersRequest {
  int64 operator_id = 1;
  optional string country = 2;
  optional OTPProviderType provider_type = 3;
  optional bool enabled = 4;
  int32 page = 5;
  int32 page_size = 6;
}

message ListOTPProvidersResponse {
  repeated OTPProviderInfo providers = 1;
  int32 total = 2;
  int32 page = 3;
  int32 page_size = 4;
}

// ============ Template CRUD ============

message OTPTemplateInfo {
  int64 id = 1;
  int64 operator_id = 2;
  string country = 3;
  int64 provider_id = 4;
  string name = 5;
  OTPTemplateType template_type = 6;
  string external_template_id = 7;
  string language = 8;
  string brand_name = 9;
  int32 code_length = 10;
  int32 code_ttl_seconds = 11;
  string extra_params = 12;  // JSON string
  OTPTemplateReviewStatus review_status = 13;
  bool enabled = 14;
  int64 created_at = 15;
  int64 updated_at = 16;
}

message CreateOTPTemplateRequest {
  int64 operator_id = 1;
  string country = 2;
  int64 provider_id = 3;
  string name = 4;
  OTPTemplateType template_type = 5;
  string external_template_id = 6;
  string language = 7;
  string brand_name = 8;
  int32 code_length = 9;
  int32 code_ttl_seconds = 10;
  string extra_params = 11;
  bool enabled = 12;
}

message CreateOTPTemplateResponse {
  OTPTemplateInfo template = 1;
}

message UpdateOTPTemplateRequest {
  int64 id = 1;
  optional string name = 2;
  optional string external_template_id = 3;
  optional string language = 4;
  optional string brand_name = 5;
  optional int32 code_length = 6;
  optional int32 code_ttl_seconds = 7;
  optional string extra_params = 8;
  optional bool enabled = 9;
}

message UpdateOTPTemplateResponse {}

message DeleteOTPTemplateRequest {
  int64 id = 1;
}

message DeleteOTPTemplateResponse {}

message GetOTPTemplateRequest {
  int64 id = 1;
}

message GetOTPTemplateResponse {
  OTPTemplateInfo template = 1;
}

message ListOTPTemplatesRequest {
  int64 operator_id = 1;
  optional string country = 2;
  optional int64 provider_id = 3;
  optional OTPTemplateType template_type = 4;
  optional bool enabled = 5;
  int32 page = 6;
  int32 page_size = 7;
}

message ListOTPTemplatesResponse {
  repeated OTPTemplateInfo templates = 1;
  int32 total = 2;
  int32 page = 3;
  int32 page_size = 4;
}

// SyncOTPTemplateStatusRequest requests a review status sync from the external provider.
message SyncOTPTemplateStatusRequest {
  int64 id = 1;  // Template ID to sync status for
}

// SyncOTPTemplateStatusResponse returns the updated review status after syncing with the provider.
//
// Possible values:
//   - LOCAL_ONLY:   No external review needed (e.g., SMS templates). The template can be used immediately.
//   - PENDING:      Template is under review by the provider (e.g., WhatsApp). Wait and sync again later.
//   - APPROVED:     Provider approved the template. It is ready for use.
//   - REJECTED:     Provider rejected the template. Fix the content on the provider's platform and resubmit.
message SyncOTPTemplateStatusResponse {
  OTPTemplateReviewStatus review_status = 1;  // The current review status after syncing with the provider
}

// ============ Send Logs ============

message OTPSendLogInfo {
  int64 id = 1;
  int64 operator_id = 2;
  int64 company_operator_id = 3;
  int64 retailer_operator_id = 4;
  int64 provider_id = 5;
  int64 template_id = 6;
  string recipient_masked = 7;   // Masked: "+1***5678", "t***@example.com"
  string channel_used = 8;
  string external_message_id = 9;
  string status = 10;
  string error_message = 11;
  int64 user_id = 12;
  string ip_address = 13;
  int64 created_at = 14;
}

message ListOTPSendLogsRequest {
  int64 operator_id = 1;
  optional int64 user_id = 2;
  optional string channel_used = 3;
  optional string status = 4;
  int64 start_time = 5;
  int64 end_time = 6;
  int32 page = 7;
  int32 page_size = 8;
}

message ListOTPSendLogsResponse {
  repeated OTPSendLogInfo logs = 1;
  int32 total = 2;
  int32 page = 3;
  int32 page_size = 4;
}
